<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Gates Slot</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: sans-serif;
      background: #300a4e;
      color: #fff;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .top-bar {
      display: flex;
      justify-content: space-between;
      width: 400px;
      margin-bottom: 10px;
    }
    .slot-grid {
      display: grid;
      grid-template-columns: repeat(4, 100px);
      grid-template-rows: repeat(3, 100px);
      gap: 5px;
      background-color: #562a86;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    .slot-cell img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 5px;
      width: 400px;
      align-items: center;
    }
    button, select {
      padding: 10px;
      border: none;
      border-radius: 5px;
      background: #ff9800;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .win-message {
      font-size: 28px;
      font-weight: bold;
      margin-top: 20px;
      text-align: center;
      animation: pop 0.5s ease-out;
    }
    @keyframes pop {
      0% { transform: scale(0.5); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="top-bar">
    <div>Saldo: <span id="saldo">...</span></div>
    <div>Bet: <span id="currentBet">400</span></div>
    <div><button onclick="topUp()">Top Up</button></div>
  </div>

  <div class="slot-grid" id="slotGrid"></div>

  <div class="controls">
    <div>
      <button onclick="decreaseBet()">-</button>
      <button onclick="increaseBet()">+</button>
      <button onclick="buyScatter()">Beli Bonus</button>
    </div>
    <div>
      <button id="spinButton" onclick="spin()">SPIN</button>
      <select id="speedSelect">
        <option value="normal">Normal Spin</option>
        <option value="fast">Fast Spin</option>
      </select>
      <select id="autoSpinSelect">
        <option value="0">Manual</option>
        <option value="10">Auto x10</option>
        <option value="30">Auto x30</option>
        <option value="50">Auto x50</option>
        <option value="100">Auto x100</option>
      </select>
    </div>
    <div class="win-message" id="winMessage"></div>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyA2F9bh-M-XbBYj14j2i93qkZiAgQHyY1I",
      authDomain: "slotkw-f05d1.firebaseapp.com",
      projectId: "slotkw-f05d1",
      storageBucket: "slotkw-f05d1.appspot.com",
      messagingSenderId: "2853362042",
      appId: "1:2853362042:web:2253bf70a2bda70f56dec3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const user = JSON.parse(sessionStorage.getItem("loggedInUser"));
    if (!user || !user.id) {
      alert("Anda belum login!");
      window.location.href = "../index.html";
    }

    let saldo = 0;
    let currentBet = 400;
    let autoSpinCount = 0;
    let isSpinning = false;

    const symbols = [
      'mahkota-removebg-preview.png',
      'jampasir-removebg-preview.png',
      'cincin-removebg-preview.png',
      'cawan-removebg-preview.png',
      'gemshijau-removebg-preview.png',
      'zeus-removebg-preview.png'
    ];

    const saldoDisplay = document.getElementById('saldo');
    const betDisplay = document.getElementById('currentBet');
    const grid = document.getElementById('slotGrid');
    const winMessage = document.getElementById('winMessage');
    const spinButton = document.getElementById('spinButton');

    db.collection("members").doc(user.id).onSnapshot(doc => {
      if (doc.exists) {
        saldo = doc.data().saldo || 0;
        updateUI();
      }
    });

    function updateFirestore() {
      db.collection("members").doc(user.id).update({
        saldo: saldo,
        turnover: firebase.firestore.FieldValue.increment(currentBet),
        currentGame: "Slot",
        lastPlayedAt: new Date()
      });
    }

    function updateUI() {
      saldoDisplay.textContent = saldo;
      betDisplay.textContent = currentBet;
    }

    function topUp() {
      saldo += 100000;
      updateFirestore();
      updateUI();
    }

    function increaseBet() {
      if (currentBet < 100000) currentBet += 400;
      updateUI();
    }

    function decreaseBet() {
      if (currentBet > 400) currentBet -= 400;
      updateUI();
    }

    function generateGrid() {
      grid.innerHTML = '';
      for (let i = 0; i < 12; i++) {
        const div = document.createElement('div');
        div.classList.add('slot-cell');
        const img = document.createElement('img');
        img.src = symbols[Math.floor(Math.random() * symbols.length)];
        div.appendChild(img);
        grid.appendChild(div);
      }
    }

    function calculateWin(callback) {
      const win = Math.floor(Math.random() * 120000);
      saldo += win;
      updateFirestore();
      let msg = '';
      if (win >= 40000) msg = 'GILE LU NDROO!';
      else if (win >= 30000) msg = 'KAMU KEREN!';
      else if (win >= 10000) msg = 'MANTAP!';
      if (msg) {
        winMessage.textContent = msg + ' +Rp' + win.toLocaleString();
      }
      updateUI();
      setTimeout(() => {
        winMessage.textContent = '';
        if (callback) callback();
      }, 2500);
    }

    function spin() {
      if (isSpinning) return;
      if (saldo < currentBet) {
        alert('Saldo tidak cukup!');
        return;
      }
      isSpinning = true;
      spinButton.disabled = true;
      saldo -= currentBet;
      updateFirestore();
      updateUI();
      generateGrid();
      const speed = document.getElementById('speedSelect').value;
      const delay = speed === 'fast' ? 500 : 1000;
      setTimeout(() => {
        calculateWin(() => {
          autoSpinCount = parseInt(document.getElementById('autoSpinSelect').value);
          isSpinning = false;
          spinButton.disabled = false;
          if (autoSpinCount > 0) {
            autoSpinCount--;
            setTimeout(spin, delay);
          }
        });
      }, delay);
    }

    function buyScatter() {
      const price = 30000 * (currentBet / 400);
      if (saldo < price) {
        alert('Saldo tidak cukup untuk beli scatter!');
        return;
      }
      saldo -= price;
      updateFirestore();
      updateUI();
      alert('Bonus dibeli! Free spin akan segera dimulai (fitur lanjut)!');
    }

    generateGrid();
  </script>
</body>
</html>
