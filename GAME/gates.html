<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gates of Olympus Slot</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: url('latar%20belakang.png') center/cover no-repeat fixed;
      color: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
    }
    .top-bar {
      width: 90vw;
      max-width: 700px;
      display: flex;
      justify-content: space-between;
      margin: 20px auto 10px;
      font-size: 18px;
      font-weight: bold;
    }
    .slot-grid {
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      grid-template-rows: repeat(5, 1fr);
      gap: 6px;
      background: rgba(0, 0, 0, 0.5);
      padding: 10px;
      border-radius: 15px;
      width: 90vw;
      max-width: 700px;
      aspect-ratio: 6/5;
      position: relative;
    }
    .slot-cell {
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid #fff2;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    .slot-cell img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      filter: drop-shadow(0 0 6px gold);
      transition: transform 0.3s ease, opacity 0.3s ease;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      align-items: center;
      width: 90vw;
      max-width: 700px;
      margin-top: 20px;
    }
    .controls > div {
      display: flex;
      gap: 10px;
    }
    button, select {
      padding: 10px 15px;
      font-size: 14px;
      font-weight: bold;
      background: linear-gradient(#ffc107, #ff9800);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 0 10px #ffcc00;
    }
    button:hover {
      background: #ffb300;
      transform: scale(1.05);
    }
    .win-message {
      font-size: 22px;
      font-weight: bold;
      color: gold;
      margin-top: 10px;
    }
    .fade-out {
      animation: fadeOut 0.3s forwards;
    }
    @keyframes fadeOut {
      to {
        opacity: 0;
        transform: scale(0.6);
      }
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <div class="top-bar">
    <div>Saldo: <span id="saldo">...</span></div>
    <div>Bet: <span id="currentBet">1000</span></div>
    <div><button onclick="topUp()">Top Up</button></div>
  </div>
  <div class="slot-grid" id="slotGrid"></div>
  <div class="controls">
    <div>
      <button onclick="decreaseBet()">-</button>
      <button onclick="increaseBet()">+</button>
      <button onclick="buyScatter()">Beli Bonus</button>
    </div>
    <div>
      <button id="spinButton" onclick="spin()">SPIN</button>
      <select id="speedSelect">
        <option value="normal">Normal Spin</option>
        <option value="fast">Fast Spin</option>
      </select>
      <select id="autoSpinSelect">
        <option value="0">Manual</option>
        <option value="10">Auto x10</option>
        <option value="30">Auto x30</option>
        <option value="50">Auto x50</option>
        <option value="100">Auto x100</option>
      </select>
    </div>
    <div class="win-message" id="winMessage"></div>
  </div>

  <script>
    // === FIREBASE INIT ===
    const firebaseConfig = {
      apiKey: "AIzaSyA2F9bh-M-XbBYj14j2i93qkZiAgQHyY1I",
      authDomain: "slotkw-f05d1.firebaseapp.com",
      projectId: "slotkw-f05d1",
      storageBucket: "slotkw-f05d1.appspot.com",
      messagingSenderId: "2853362042",
      appId: "1:2853362042:web:2253bf70a2bda70f56dec3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // === GLOBAL VARIABEL ===
    const symbols = [
      'mahkota-removebg-preview.png',
      'jampasir-removebg-preview.png',
      'cincin-removebg-preview.png',
      'cawan-removebg-preview.png',
      'gemshijau-removebg-preview.png',
      'zeus-removebg-preview.png'
    ];
    const ROWS = 5, COLS = 6;
    let saldo = 0, currentBet = 1000;
    let autoSpinCount = 0, isSpinning = false;
    let isFreeSpin = false, freeSpinCount = 0, freeSpinTotalWin = 0;
    let spinCount = 0, activeMultiplier = 1;
    let currentGrid = [];
    let userDocId = null;

    // === DOM REFERENCES ===
    const grid = document.getElementById('slotGrid');
    const saldoDisplay = document.getElementById('saldo');
    const betDisplay = document.getElementById('currentBet');
    const winMessage = document.getElementById('winMessage');
    const spinButton = document.getElementById('spinButton');

    // === USER AUTH ===
    const user = JSON.parse(sessionStorage.getItem("loggedInUser"));
    if (!user || !user.username) {
      alert("Anda belum login!");
      window.location.href = "/NEWW/index.html";
    }

    db.collection("members").where("username", "==", user.username).get().then(snapshot => {
      if (!snapshot.empty) {
        const doc = snapshot.docs[0];
        userDocId = doc.id;
        saldo = doc.data().saldo || 0;
        updateUI();
        createGrid();
      }
    });

    // === UI UPDATE ===
    function updateUI() {
      saldoDisplay.textContent = saldo.toLocaleString();
      betDisplay.textContent = currentBet.toLocaleString();
    }

    function updateSaldoFirestore() {
      if (userDocId) {
        db.collection("members").doc(userDocId).update({
          saldo,
          turnover: firebase.firestore.FieldValue.increment(currentBet),
          currentGame: "Zeus Slot",
          lastPlayedAt: new Date()
        });
      }
    }

    // === BET CONTROLS ===
    function topUp() {
      saldo += 100000;
      updateUI();
      updateSaldoFirestore();
    }

    function increaseBet() {
      if (currentBet < 100000) currentBet += 100;
      updateUI();
    }

    function decreaseBet() {
      if (currentBet > 100) currentBet -= 100;
      updateUI();
    }

    // === SPIN LOGIC ===
    function createGrid() {
      currentGrid = Array.from({ length: ROWS }, () => []);
      grid.innerHTML = '';
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          const sym = symbols[Math.floor(Math.random() * symbols.length)];
          currentGrid[r][c] = sym;
          const cell = document.createElement('div');
          cell.className = 'slot-cell';
          const img = document.createElement('img');
          img.src = sym;
          cell.appendChild(img);
          grid.appendChild(cell);
        }
      }
      if (!isFreeSpin && checkFreeScatter()) {
        isFreeSpin = true;
        freeSpinCount = 12;
        freeSpinTotalWin = 0;
        alert('Scatter Gratis! Kamu dapat 12 Free Spin!');
      }
    }

    function checkFreeScatter() {
      for (let row = 0; row < ROWS; row++) {
        if (currentGrid[row].slice(0, 4).every(sym => sym === 'zeus-removebg-preview.png')) {
          return true;
        }
      }
      return false;
    }

    function detectClusterWins() {
      const visited = Array.from({ length: ROWS }, () => Array(COLS).fill(false));
      const clusters = [];
      function dfs(r, c, symbol, group) {
        if (r < 0 || r >= ROWS || c < 0 || c >= COLS || visited[r][c]) return;
        if (currentGrid[r][c] !== symbol) return;
        visited[r][c] = true;
        group.push([r, c]);
        dfs(r - 1, c, symbol, group);
        dfs(r + 1, c, symbol, group);
        dfs(r, c - 1, symbol, group);
        dfs(r, c + 1, symbol, group);
      }
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          if (!visited[r][c]) {
            const group = [];
            dfs(r, c, currentGrid[r][c], group);
            if (group.length >= 8 && currentGrid[r][c] !== 'zeus-removebg-preview.png') {
              clusters.push(group);
            }
          }
        }
      }
      return clusters;
    }

    function showWinMessage(win) {
      const msg = win >= 40000 ? 'GILE LU NDROO!' : win >= 30000 ? 'KAMU KEREN!' : win >= 10000 ? 'MANTAP!' : '';
      winMessage.textContent = win > 0 ? `${msg} +Rp${win.toLocaleString()} ×${activeMultiplier}` : '';
      setTimeout(() => winMessage.textContent = '', 1500);
    }

    function animateTumble(callback) {
      for (let col = 0; col < COLS; col++) {
        let stack = [];
        for (let row = ROWS - 1; row >= 0; row--) {
          if (currentGrid[row][col]) stack.push(currentGrid[row][col]);
        }
        while (stack.length < ROWS) {
          stack.push(symbols[Math.floor(Math.random() * symbols.length)]);
        }
        for (let row = ROWS - 1; row >= 0; row--) {
          currentGrid[row][col] = stack[ROWS - 1 - row];
        }
      }
      renderGrid();
      setTimeout(() => tumble(callback), 300);
    }

    function tumble(callback) {
      const clusters = detectClusterWins();
      if (clusters.length === 0) {
        if (callback) callback();
        return;
      }
      let winAmount = 0;
      clusters.forEach(group => {
        winAmount += currentBet * (isFreeSpin ? 10 : 6) * activeMultiplier;
        group.forEach(([r, c]) => {
          const index = r * COLS + c;
          const img = grid.children[index].querySelector('img');
          img.classList.add('fade-out');
          setTimeout(() => img.remove(), 300);
          currentGrid[r][c] = null;
        });
      });
      if (isFreeSpin) freeSpinTotalWin += winAmount;
      else saldo += winAmount;
      showWinMessage(winAmount);
      setTimeout(() => animateTumble(callback), 400);
    }

    function renderGrid() {
      grid.innerHTML = '';
      for (let r = 0; r < ROWS; r++) {
        for (let c = 0; c < COLS; c++) {
          const sym = currentGrid[r][c];
          const cell = document.createElement('div');
          cell.className = 'slot-cell';
          const img = document.createElement('img');
          img.src = sym;
          cell.appendChild(img);
          grid.appendChild(cell);
        }
      }
    }

    function spin() {
      if (isSpinning) return;
      if (!isFreeSpin && saldo < currentBet) {
        alert("Saldo tidak cukup!");
        window.location.href = "/NEWW/MEMBER/dashboard.html";
        return;
      }
      isSpinning = true;
      spinButton.disabled = true;
      if (!isFreeSpin) saldo -= currentBet;
      spinCount++;
      activeMultiplier = 1;
      if (spinCount >= 10) {
        const multipliers = [2, 3, 5, 10, 25, 50, 100];
        const weights = [30, 25, 20, 10, 8, 5, 2];
        let rand = Math.random() * weights.reduce((a, b) => a + b), sum = 0;
        for (let i = 0; i < multipliers.length; i++) {
          sum += weights[i];
          if (rand < sum) {
            activeMultiplier = multipliers[i];
            break;
          }
        }
        spinCount = 0;
        const m = document.createElement('div');
        m.style.position = 'absolute';
        m.style.top = '45%';
        m.style.left = '50%';
        m.style.transform = 'translate(-50%, -50%)';
        m.style.fontSize = '48px';
        m.style.color = 'yellow';
        m.style.fontWeight = 'bold';
        m.style.textShadow = '2px 2px 10px #000';
        m.textContent = `×${activeMultiplier}`;
        document.body.appendChild(m);
        setTimeout(() => m.remove(), 1500);
      }
      updateUI();
      createGrid();
      setTimeout(() => {
        tumble(() => {
          if (isFreeSpin) {
            freeSpinCount--;
            if (freeSpinCount > 0) {
              isSpinning = false;
              setTimeout(spin, 500);
            } else {
              saldo += freeSpinTotalWin;
              alert(`Free Spin selesai! Total menang: Rp${freeSpinTotalWin.toLocaleString()}`);
              isFreeSpin = false;
              freeSpinTotalWin = 0;
              isSpinning = false;
              spinButton.disabled = false;
              updateSaldoFirestore();
            }
          } else {
            autoSpinCount = parseInt(document.getElementById('autoSpinSelect').value);
            isSpinning = false;
            spinButton.disabled = false;
            updateSaldoFirestore();
            if (autoSpinCount > 0) {
              autoSpinCount--;
              setTimeout(spin, 500);
            }
          }
          updateUI();
        });
      }, 300);
    }

    function buyScatter() {
      const price = 30000 * (currentBet / 400);
      if (saldo < price) {
        alert("Saldo tidak cukup untuk beli scatter!");
        return;
      }
      saldo -= price;
      updateUI();
      updateSaldoFirestore();
      isFreeSpin = true;
      freeSpinCount = 12;
      freeSpinTotalWin = 0;
      alert("Bonus dibeli! Free spin dimulai!");
      spin();
    }
  </script>
</body>
</html>
